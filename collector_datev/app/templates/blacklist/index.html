{% extends "base.html" %}

{% block title %}Blacklist - Collector DATEV{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-3xl font-bold">Domain Blacklist</h1>
        <p class="text-base-content/70 mt-1">
            {{ domains | length }} Domains
            {% if selected_category %}
                in <span class="badge badge-{{ selected_category.color }}">{{ selected_category.name }}</span>
            {% else %}
                in {{ categories | length }} Kategorien
            {% endif %}
        </p>
    </div>
    <div class="flex gap-2">
        <a href="{{ url_for('blacklist.categories') }}" class="btn btn-outline">
            <i class="ti ti-category"></i>
            Kategorien verwalten
        </a>
        <button class="btn btn-primary" onclick="add_modal.showModal()">
            <i class="ti ti-plus"></i>
            Domain hinzufügen
        </button>
    </div>
</div>

<!-- Category Filter -->
<div class="flex flex-wrap gap-2 mb-4">
    <a href="{{ url_for('blacklist.index', category='') }}"
       class="btn btn-sm {% if not category_filter %}btn-primary{% else %}btn-ghost{% endif %}">
        Alle ({{ categories | sum(attribute='domain_count') }})
    </a>
    {% for cat in categories %}
    <a href="{{ url_for('blacklist.index', category=cat.id) }}"
       class="btn btn-sm {% if category_filter == cat.id %}btn-primary{% else %}btn-ghost{% endif %}">
        <span class="badge badge-{{ cat.color }} badge-xs"></span>
        {{ cat.name }} ({{ cat.domain_count }})
    </a>
    {% endfor %}
</div>

<!-- Domains Table -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="overflow-x-auto">
            <table class="table" data-datatable>
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Kategorie</th>
                        <th>Grund</th>
                        <th>Erstellt</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain in domains %}
                    <tr>
                        <td class="font-mono">{{ domain.domain }}</td>
                        <td>
                            <span class="badge badge-{{ domain.category_color }} gap-1">
                                {{ domain.category_name }}
                            </span>
                        </td>
                        <td class="max-w-xs truncate">{{ domain.reason or '-' }}</td>
                        <td>{{ domain.created_at.strftime('%d.%m.%Y') if domain.created_at else '-' }}</td>
                        <td>
                            <div class="join">
                                <a href="https://{{ domain.domain }}" target="_blank" rel="noopener"
                                   class="btn btn-ghost btn-xs join-item" title="Im Browser öffnen">
                                    <i class="ti ti-external-link"></i>
                                </a>
                                <button class="btn btn-ghost btn-xs join-item"
                                        onclick="openEditModal({{ domain.id }}, '{{ domain.domain }}', {{ domain.category_id or 'null' }}, '{{ domain.reason or '' }}')"
                                        title="Bearbeiten">
                                    <i class="ti ti-edit"></i>
                                </button>
                                <form action="{{ url_for('blacklist.delete', domain_id=domain.id) }}"
                                      method="POST"
                                      onsubmit="return confirm('Domain wirklich löschen?')">
                                    <button type="submit" class="btn btn-ghost btn-xs text-error join-item" title="Löschen">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Modal -->
<dialog id="add_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Domain hinzufügen</h3>
        <form action="{{ url_for('blacklist.add') }}" method="POST">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Domain</span>
                </label>
                <input type="text" name="domain" placeholder="z.B. gmail.com" class="input input-bordered" required>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Kategorie</span>
                </label>
                <select name="category_id" class="select select-bordered">
                    <option value="">-- Keine Kategorie --</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Grund (optional)</span>
                </label>
                <textarea name="reason" class="textarea textarea-bordered" placeholder="Warum auf der Blacklist?"></textarea>
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="add_modal.close()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Hinzufügen</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Edit Modal -->
<dialog id="edit_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Domain bearbeiten</h3>
        <form id="edit_form" method="POST">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Domain</span>
                </label>
                <input type="text" name="domain" id="edit_domain" class="input input-bordered" required>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Kategorie</span>
                </label>
                <select name="category_id" id="edit_category_id" class="select select-bordered">
                    <option value="">-- Keine Kategorie --</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Grund (optional)</span>
                </label>
                <textarea name="reason" id="edit_reason" class="textarea textarea-bordered"></textarea>
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="edit_modal.close()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Speichern</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
function openEditModal(id, domain, categoryId, reason) {
    document.getElementById('edit_form').action = '/blacklist/edit/' + id;
    document.getElementById('edit_domain').value = domain;
    document.getElementById('edit_category_id').value = categoryId || '';
    document.getElementById('edit_reason').value = reason;
    edit_modal.showModal();
}
</script>
{% endblock %}
