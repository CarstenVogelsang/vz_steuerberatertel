{% extends "base.html" %}

{% block title %}Jobs - Collector DATEV{% endblock %}

{% block content %}
{# Single Source of Truth: Job descriptions defined ONCE, used in HTML and JavaScript #}
{% set job_descriptions = {
    'scraper': 'Durchsucht den Bundesweiten Steuerberater-Suchdienst (datev.de/kasus) nach PLZ und speichert neue Einträge in Google Sheets. Bereits vorhandene Steuerberater (gleiche PLZ+Name) werden übersprungen.',
    'collector_bstbk': 'Scraped das Steuerberaterverzeichnis der Bundessteuerberaterkammer (berufs-org.de) und speichert Kanzleien und Steuerberater in SQLite. Unterstützt KI-gestütztes Matching.',
    'enrich_email': 'Extrahiert Website-URLs aus E-Mail-Adressen der Steuerberater (z.B. info@kanzlei.de → kanzlei.de). Schnelle Methode mit hoher Trefferquote.',
    'enrich_search': 'Sucht per Web-Suche nach Websites für Steuerberater ohne bekannte URL. Nutzt Serper/Brave/DuckDuckGo APIs.',
    'blacklist_sync': 'Synchronisiert die Domain-Blacklist aus der SQLite-Datenbank mit der lokalen domain_blacklist.txt Datei.'
} %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Jobs</h1>
    <button class="btn btn-primary" onclick="new_job_modal.showModal()" {% if running_job %}disabled{% endif %}>
        <i class="ti ti-plus"></i>
        Neuer Job
    </button>
</div>

<!-- Running Job -->
{% if running_job %}
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="card-title">
                    <span class="loading loading-spinner loading-sm text-primary"></span>
                    {{ running_job.job_type }}
                </h2>
                <p class="text-sm text-base-content/70">
                    Gestartet: {{ running_job.started_at.strftime('%H:%M:%S') if running_job.started_at else '-' }}
                </p>
            </div>
            <form hx-delete="/api/jobs/{{ running_job.id }}"
                  hx-confirm="Job wirklich abbrechen?"
                  hx-swap="none"
                  hx-on::after-request="if(event.detail.successful) { setTimeout(() => window.location.reload(), 1000); }">
                <button class="btn btn-outline btn-error btn-sm">
                    <i class="ti ti-player-stop"></i>
                    Abbrechen
                </button>
            </form>
        </div>

        <!-- Live Log Output (HTMX SSE - Server sends HTML directly) -->
        <!-- Note: Server sends heartbeat every 15s to keep connection alive -->
        <!-- CSS Override: daisyUI mockup-code überschreibt text-* Klassen -->
        <style>
            #live-log-output code.text-info { color: oklch(var(--in)) !important; }
            #live-log-output code.text-success { color: oklch(var(--su)) !important; }
            #live-log-output code.text-warning { color: oklch(var(--wa)) !important; }
            #live-log-output code.text-error { color: oklch(var(--er)) !important; }
            #live-log-output code { color: oklch(var(--bc)) !important; }
        </style>
        <div class="mockup-code bg-base-300 max-h-96 overflow-y-auto mt-4" id="live-log-output"
             hx-ext="sse"
             sse-connect="/jobs/stream/{{ running_job.id }}"
             sse-swap="message"
             hx-swap="afterbegin">
            <pre data-prefix=">"><code>Verbinde...</code></pre>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Jobs -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <h2 class="card-title mb-4">
            <i class="ti ti-history"></i>
            Job-Verlauf
        </h2>

        {% if recent_jobs %}
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Typ</th>
                        <th>Parameter</th>
                        <th>Status</th>
                        <th>Gestartet</th>
                        <th>Dauer</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in recent_jobs %}
                    <tr>
                        <td>#{{ job.id }}</td>
                        <td>{{ job.job_type }}</td>
                        <td>
                            {% if job.parameters %}
                            <div class="flex flex-wrap gap-1">
                                {% if job.parameters.plz_filter %}
                                <span class="badge badge-sm">PLZ: {{ job.parameters.plz_filter }}</span>
                                {% endif %}
                                {% if not job.parameters.headless %}
                                <span class="badge badge-sm badge-ghost">sichtbar</span>
                                {% endif %}
                                {% if job.parameters.dry_run %}
                                <span class="badge badge-sm badge-warning">dry-run</span>
                                {% endif %}
                                {% if job.parameters.search_provider %}
                                <span class="badge badge-sm badge-outline">{{ job.parameters.search_provider }}</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-base-content/50">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if job.status == 'completed' %}
                            <span class="badge badge-success gap-1">
                                <i class="ti ti-check"></i> Erfolgreich
                            </span>
                            {% elif job.status == 'failed' %}
                            <span class="badge badge-error gap-1">
                                <i class="ti ti-x"></i> Fehlgeschlagen
                            </span>
                            {% elif job.status == 'running' %}
                            <span class="badge badge-info gap-1">
                                <span class="loading loading-spinner loading-xs"></span> Läuft
                            </span>
                            {% elif job.status == 'cancelled' %}
                            <span class="badge badge-warning gap-1">
                                <i class="ti ti-player-stop"></i> Abgebrochen
                            </span>
                            {% elif job.status == 'pending' %}
                            <span class="badge badge-ghost gap-1">
                                <i class="ti ti-clock"></i> Wartend
                            </span>
                            {% endif %}
                        </td>
                        <td>{{ job.started_at.strftime('%d.%m.%Y %H:%M') if job.started_at else '-' }}</td>
                        <td>{{ job.duration_formatted }}</td>
                        <td>
                            <div class="flex gap-1">
                                <a href="{{ url_for('jobs.detail', job_id=job.id) }}" class="btn btn-ghost btn-sm">
                                    <i class="ti ti-eye"></i>
                                    Logs
                                </a>
                                {% if job.status in ('failed', 'cancelled') %}
                                <form hx-post="/api/jobs/{{ job.id }}/restart"
                                      hx-confirm="Job mit gleichen Parametern neu starten?"
                                      hx-swap="none"
                                      class="inline">
                                    <button class="btn btn-ghost btn-sm text-warning" title="Neu starten">
                                        <i class="ti ti-refresh"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-base-content/50">Noch keine Jobs ausgeführt.</p>
        {% endif %}
    </div>
</div>

<!-- New Job Modal -->
<dialog id="new_job_modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Neuen Job starten</h3>

        <form id="new_job_form">
            <!-- Job Type Selection + Description (side by side) -->
            <div class="flex gap-6 mb-4">
                <!-- Left: Job Types -->
                <div class="flex-1">
                    <label class="label">
                        <span class="label-text font-semibold">Job-Typ</span>
                    </label>
                    {% for value, label in job_types %}
                    <label class="label cursor-pointer gap-4 border rounded-lg p-4 hover:bg-base-200 mb-2 job-type-option"
                           data-job-type="{{ value }}"
                           onmouseenter="showJobDescription('{{ value }}')"
                           onmouseleave="showSelectedJobDescription()">
                        <div class="flex items-center gap-3">
                            <input type="radio" name="job_type" value="{{ value }}"
                                   class="radio radio-primary"
                                   {% if loop.first %}checked{% endif %}
                                   onchange="updateJobParameters(); showJobDescription('{{ value }}')">
                            <div>
                                <span class="font-semibold">{{ label }}</span>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>

                <!-- Right: Description (sticky) -->
                <div class="w-72">
                    <label class="label">
                        <span class="label-text font-semibold">Beschreibung</span>
                    </label>
                    <div id="job-description" class="alert alert-info">
                        <i class="ti ti-info-circle"></i>
                        <span id="job-description-text">{{ job_descriptions['scraper'] }}</span>
                    </div>
                </div>
            </div>

            <!-- Parameters Section -->
            <div id="job-parameters" class="border-t pt-4">
                <h4 class="font-semibold mb-4">Parameter</h4>

                <!-- PLZ Filter -->
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">PLZ-Filter</span>
                    </label>
                    <input type="text" name="plz_filter" id="plz_filter_input"
                           placeholder="z.B. 4 für PLZ 40000-49999"
                           class="input input-bordered">
                    <label class="label">
                        <span class="label-text-alt">Leer = alle PLZ</span>
                    </label>
                </div>

                <!-- PLZ Status (dynamically loaded) -->
                <div id="plz-status-container" class="mb-4 hidden">
                    <div id="plz-status-info" class="alert alert-info">
                        <i class="ti ti-info-circle"></i>
                        <span id="plz-status-text"></span>
                    </div>
                </div>

                <!-- Re-Scraping Option -->
                <div id="rescrape-section" class="form-control mb-4 hidden">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="force_rescrape" id="force_rescrape" class="checkbox checkbox-warning">
                        <span class="label-text">Bereits verarbeitete PLZ erneut scrapen</span>
                    </label>
                </div>

                <!-- Update Mode (only visible when force_rescrape is checked) -->
                <div id="update-mode-section" class="mb-4 hidden pl-8">
                    <label class="label-text font-medium">Daten-Aktualisierung</label>
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="radio" name="update_mode" value="add_only" class="radio radio-sm" checked>
                            <span class="label-text">Nur neue Daten hinzufügen (Standard)</span>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="radio" name="update_mode" value="update" class="radio radio-sm">
                            <span class="label-text">Bestehende Daten aktualisieren</span>
                        </label>
                    </div>
                </div>

                <!-- Confidence Filter (for enrich_search) -->
                <div id="confidence-options" class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Confidence-Level</span>
                    </label>
                    <div class="flex flex-wrap gap-4">
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="confidence_none" class="checkbox checkbox-sm" checked>
                            <span class="label-text">Keine Website</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="confidence_low" class="checkbox checkbox-sm" checked>
                            <span class="label-text">Niedrig</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="confidence_medium" class="checkbox checkbox-sm">
                            <span class="label-text">Mittel</span>
                        </label>
                    </div>
                </div>

                <!-- Search Provider (for enrich_search) -->
                <div id="provider-options" class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Such-Provider</span>
                    </label>
                    <select name="search_provider" class="select select-bordered">
                        <option value="brave">Brave Search (2.000 free/Monat)</option>
                        <option value="serper">Serper (2.500 free/Monat)</option>
                        <option value="duckduckgo">DuckDuckGo (kostenlos, instabil)</option>
                        <option value="serpapi">SerpAPI (kostenpflichtig)</option>
                    </select>
                </div>

                <!-- Options -->
                <div class="form-control mb-4">
                    <div class="flex flex-wrap gap-4">
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="headless" class="checkbox checkbox-sm" checked>
                            <span class="label-text">Headless Mode</span>
                        </label>
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="dry_run" class="checkbox checkbox-sm">
                            <span class="label-text">Dry Run</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="new_job_modal.close()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">
                    <i class="ti ti-player-play"></i>
                    Job starten
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Single Source of Truth: Exported from Jinja template
const JOB_DESCRIPTIONS = {{ job_descriptions | tojson }};

// Show description for a specific job type (used on hover)
function showJobDescription(jobType) {
    const description = JOB_DESCRIPTIONS[jobType] || 'Keine Beschreibung verfügbar.';
    document.getElementById('job-description-text').textContent = description;
}

// Show description for the currently SELECTED job (used on mouseleave)
function showSelectedJobDescription() {
    const selected = document.querySelector('input[name="job_type"]:checked');
    if (selected) {
        showJobDescription(selected.value);
    }
}

function updateJobParameters() {
    const jobType = document.querySelector('input[name="job_type"]:checked').value;
    const confidenceOptions = document.getElementById('confidence-options');
    const providerOptions = document.getElementById('provider-options');
    const rescrapeSection = document.getElementById('rescrape-section');

    // Show/hide options based on job type
    if (jobType === 'enrich_search') {
        confidenceOptions.style.display = 'block';
        providerOptions.style.display = 'block';
    } else {
        confidenceOptions.style.display = 'none';
        providerOptions.style.display = 'none';
    }

    // Show re-scrape option for collector jobs
    if (jobType === 'collector_bstbk' || jobType === 'scraper') {
        rescrapeSection.classList.remove('hidden');
        // Trigger PLZ status check
        checkPlzStatus();
    } else {
        rescrapeSection.classList.add('hidden');
        document.getElementById('plz-status-container').classList.add('hidden');
    }
}

// PLZ Status check with debounce
let plzStatusTimeout;
function checkPlzStatus() {
    const jobType = document.querySelector('input[name="job_type"]:checked').value;
    if (jobType !== 'collector_bstbk' && jobType !== 'scraper') return;

    clearTimeout(plzStatusTimeout);
    plzStatusTimeout = setTimeout(async () => {
        const plzInput = document.getElementById('plz_filter_input');
        const filter = plzInput.value.trim();
        const collector = jobType === 'collector_bstbk' ? 'bstbk' : 'datev';

        const statusContainer = document.getElementById('plz-status-container');
        const statusInfo = document.getElementById('plz-status-info');
        const statusText = document.getElementById('plz-status-text');

        try {
            const res = await fetch(`/api/jobs/plz-status?filter=${filter}&collector=${collector}`);
            const data = await res.json();

            statusContainer.classList.remove('hidden');

            if (data.all_processed) {
                statusInfo.className = 'alert alert-warning';
                statusText.innerHTML = `<strong>Alle ${data.total} PLZ bereits verarbeitet!</strong><br>
                    Aktiviere "Erneut scrapen" um die Daten zu aktualisieren.`;
            } else if (data.pending === data.total) {
                statusInfo.className = 'alert alert-success';
                statusText.textContent = `${data.total} PLZ noch ausstehend`;
            } else {
                statusInfo.className = 'alert alert-info';
                statusText.textContent = `${data.pending} von ${data.total} PLZ noch ausstehend`;
            }
        } catch (error) {
            statusContainer.classList.add('hidden');
        }
    }, 300);
}

// Toggle update mode visibility based on force_rescrape checkbox
function toggleUpdateMode() {
    const forceRescrape = document.getElementById('force_rescrape').checked;
    const updateModeSection = document.getElementById('update-mode-section');

    if (forceRescrape) {
        updateModeSection.classList.remove('hidden');
    } else {
        updateModeSection.classList.add('hidden');
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    updateJobParameters();

    // Add event listeners
    document.getElementById('plz_filter_input').addEventListener('input', checkPlzStatus);
    document.getElementById('force_rescrape').addEventListener('change', toggleUpdateMode);
});

// Handle form submission
document.getElementById('new_job_form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const jobType = formData.get('job_type');

    // Build parameters
    const parameters = {
        plz_filter: formData.get('plz_filter') || null,
        headless: formData.get('headless') === 'on',
        dry_run: formData.get('dry_run') === 'on',
    };

    // Re-scraping parameters (for collector jobs)
    if (jobType === 'collector_bstbk' || jobType === 'scraper') {
        parameters.force_rescrape = formData.get('force_rescrape') === 'on';
        if (parameters.force_rescrape) {
            parameters.update_mode = formData.get('update_mode') || 'add_only';
        }
    }

    if (jobType === 'enrich_search') {
        const confidenceFilter = [];
        if (formData.get('confidence_none')) confidenceFilter.push('none');
        if (formData.get('confidence_low')) confidenceFilter.push('low');
        if (formData.get('confidence_medium')) confidenceFilter.push('medium');
        parameters.confidence_filter = confidenceFilter;
        parameters.search_provider = formData.get('search_provider');
    }

    try {
        const response = await fetch('/api/jobs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                job_type: jobType,
                parameters: parameters
            })
        });

        if (response.ok) {
            new_job_modal.close();
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Fehler beim Starten des Jobs');
        }
    } catch (error) {
        alert('Fehler: ' + error.message);
    }
});

// Note: SSE log handling is done by HTMX (sse-swap="message")
// Server sends pre-formatted HTML, HTMX inserts it directly

// Auto-reload page when job finishes (detect final status messages)
const logOutput = document.getElementById('live-log-output');
if (logOutput) {
    const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
            for (const node of mutation.addedNodes) {
                if (node.textContent) {
                    const text = node.textContent;
                    // Check for final status messages
                    if (text.includes('✓ Abgeschlossen') ||
                        text.includes('✗ Fehlgeschlagen') ||
                        text.includes('⊘ Abgebrochen')) {
                        // Wait 2 seconds then reload to show updated status
                        setTimeout(() => window.location.reload(), 2000);
                        observer.disconnect();
                        return;
                    }
                }
            }
        }
    });
    observer.observe(logOutput, { childList: true });
}

// Reload page after successful job restart
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.pathInfo.requestPath.includes('/restart') && event.detail.successful) {
        window.location.reload();
    }
});

// Timeout-Warnung für hängende Jobs
const TIMEOUT_WARNING_MS = 5 * 60 * 1000; // 5 Minuten

function checkJobTimeout() {
    const logOutput = document.getElementById('live-log-output');
    if (!logOutput) return;

    // Finde die neueste Log-Zeile (wird oben eingefügt via afterbegin)
    const firstPre = logOutput.querySelector('pre:first-child');
    if (!firstPre) return;

    // Timestamp aus data-prefix extrahieren (Format: HH:MM:SS)
    const timestamp = firstPre.dataset?.prefix;
    if (!timestamp || timestamp === '>' || timestamp === '→') return;

    // Parse Timestamp
    const parts = timestamp.split(':');
    if (parts.length !== 3) return;

    const [h, m, s] = parts.map(Number);
    if (isNaN(h) || isNaN(m) || isNaN(s)) return;

    // Berechne Zeitdifferenz
    const now = new Date();
    const logTime = new Date();
    logTime.setHours(h, m, s, 0);

    // Falls Log-Zeit "in der Zukunft" ist (Mitternacht-Übergang), ignorieren
    if (logTime > now) return;

    const diff = now - logTime;
    if (diff > TIMEOUT_WARNING_MS) {
        showTimeoutWarning(Math.floor(diff / 60000));
    }
}

function showTimeoutWarning(minutes) {
    const existing = document.getElementById('timeout-warning');
    if (existing) {
        // Update existing warning
        existing.querySelector('span').innerHTML = `
            <strong>Job scheint zu hängen!</strong> Keine Aktivität seit ${minutes} Minuten.
            Versuche den Job abzubrechen.
        `;
        return;
    }

    const warning = document.createElement('div');
    warning.id = 'timeout-warning';
    warning.className = 'alert alert-warning mt-4';
    warning.innerHTML = `
        <i class="ti ti-alert-triangle"></i>
        <span><strong>Job scheint zu hängen!</strong> Keine Aktivität seit ${minutes} Minuten.
        Versuche den Job abzubrechen.</span>
    `;

    const logOutput = document.getElementById('live-log-output');
    if (logOutput && logOutput.parentNode) {
        logOutput.parentNode.insertBefore(warning, logOutput);
    }
}

// Prüfe alle 30 Sekunden ob Job hängt
if (document.getElementById('live-log-output')) {
    setInterval(checkJobTimeout, 30000);
    // Erste Prüfung nach 10 Sekunden
    setTimeout(checkJobTimeout, 10000);
}
</script>
{% endblock %}
